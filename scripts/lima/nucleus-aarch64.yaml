# Lima VM template for Nucleus on Apple Silicon (M1/M2/M3/M4)
# This template is optimized for Firecracker microVM support with nested virtualization.
#
# Compatible with Lima v1.x and v2.0+ (CNCF incubating).
# Lima v2.0 adds AI agent isolation features and improved vz driver support.
#
# Usage:
#   limactl create --name nucleus nucleus-aarch64.yaml
#   limactl start nucleus

# Ubuntu 24.04 LTS cloud image for ARM64
images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# VM resources - adjust based on workload
cpus: 4
memory: "8GiB"
disk: "50GiB"

# Use Apple Virtualization.framework for native performance
vmType: "vz"

# Enable Rosetta for running x86_64 binaries (optional but useful)
rosetta:
  enabled: true
  binfmt: true

# CRITICAL: Enable nested virtualization for Firecracker/KVM support
# Requires: M3/M4 chip + macOS 15 (Sequoia) for hardware acceleration
# On M1/M2 or older macOS, this falls back to emulation (slower but works)
nestedVirtualization: true

# Mount the host filesystem read-only by default
mounts:
  - location: "~"
    writable: false
  - location: "/tmp/lima"
    writable: true

# Port forwarding for nucleus services
portForwards:
  # nucleus-node HTTP API
  - guestPort: 8080
    hostPort: 8080
  # nucleus-node metrics
  - guestPort: 9080
    hostPort: 9080
  # gRPC port (HTTP + 1000)
  - guestPort: 4002
    hostPort: 4002

# Provision the VM with required packages
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -euo pipefail

      # Update package lists
      apt-get update

      # Install required packages
      apt-get install -y \
        ca-certificates \
        curl \
        iptables \
        iproute2 \
        dnsmasq \
        e2fsprogs

      # Create nucleus directories
      mkdir -p /var/lib/nucleus/artifacts
      mkdir -p /var/lib/nucleus/pods
      mkdir -p /var/log/nucleus

      # Download Firecracker if not present
      if [ ! -f /usr/local/bin/firecracker ]; then
        FIRECRACKER_VERSION="v1.14.0"
        curl -fsSL "https://github.com/firecracker-microvm/firecracker/releases/download/${FIRECRACKER_VERSION}/firecracker-${FIRECRACKER_VERSION}-aarch64.tgz" | \
          tar -xz -C /tmp
        mv /tmp/release-${FIRECRACKER_VERSION}-aarch64/firecracker-${FIRECRACKER_VERSION}-aarch64 /usr/local/bin/firecracker
        mv /tmp/release-${FIRECRACKER_VERSION}-aarch64/jailer-${FIRECRACKER_VERSION}-aarch64 /usr/local/bin/jailer
        chmod +x /usr/local/bin/firecracker /usr/local/bin/jailer
        rm -rf /tmp/release-${FIRECRACKER_VERSION}-aarch64
      fi

      # Download kernel if not present
      if [ ! -f /var/lib/nucleus/artifacts/vmlinux ]; then
        KERNEL_VERSION="v6.1"
        curl -fsSL "https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.14/aarch64/vmlinux-6.1" \
          -o /var/lib/nucleus/artifacts/vmlinux
      fi

# Message shown after VM creation
message: |
  Nucleus Lima VM created successfully!

  To complete setup:
    1. Copy nucleus-node binary:
       limactl cp nucleus-node nucleus:/usr/local/bin/

    2. Copy rootfs image:
       limactl cp rootfs.ext4 nucleus:/var/lib/nucleus/artifacts/

    3. Start nucleus-node:
       limactl shell nucleus -- sudo nucleus-node

  For hardware-accelerated Firecracker (M3/M4 + macOS 15):
    limactl shell nucleus -- ls -la /dev/kvm
    # Should show: crw-rw-rw- 1 root kvm ...
